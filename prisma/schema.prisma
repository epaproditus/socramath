generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// NextAuth Models

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]

  // App Relations
  role                String?                   @default("student")
  localId             String?                   @unique
  classPeriod         String?
  testSessions        TestSession[]
  lessons             Lesson[]
  lessonSessionStates LessonSessionState[]
  lessonResponses     LessonResponse[]
  lessonSlideStates   LessonStudentSlideState[]
  studentResponses    StudentResponse[]
  sessionLocks        StudentSessionLock[]
  sessionStates       StudentSessionState[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// App Models

model TestSession {
  id                String   @id @default(cuid())
  userId            String
  title             String   @default("New Session")
  isActive          Boolean  @default(false)
  lockQuestionIndex Int?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  user             User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  questions        Question[]
  studentResponses StudentResponse[]
  studentLocks     StudentSessionLock[]
  studentStates    StudentSessionState[]
}

model Question {
  id              String   @id @default(cuid())
  sessionId       String
  text            String
  imageUrl        String?
  studentResponse String
  rubric          String // Store as JSON string since SQLite doesn't support arrays
  vocabulary      String? // Store as JSON string
  orderIndex      Int      @default(0)
  createdAt       DateTime @default(now())

  session          TestSession       @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  studentResponses StudentResponse[]
}

model StudentResponse {
  id               String   @id @default(cuid())
  userId           String
  sessionId        String
  questionId       String
  initialReasoning String?
  originalAnswer   String?
  difficulty       Int?
  confidence       Int?
  revisedAnswer    String?
  summary          String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  session  TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question Question    @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, sessionId, questionId])
}

model StudentSessionLock {
  id               String   @id @default(cuid())
  sessionId        String
  userId           String
  maxQuestionIndex Int
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  session TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
}

model StudentSessionState {
  id                   String   @id @default(cuid())
  sessionId            String
  userId               String
  currentQuestionIndex Int      @default(1)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  session TestSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
}

model AppConfig {
  id           String   @id @default(cuid())
  baseUrl      String?
  apiKey       String?
  model        String?
  systemPrompt String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

model Lesson {
  id             String   @id @default(cuid())
  userId         String
  title          String
  content        String
  sourceFilename String?
  pdfPath        String?
  pageCount      Int      @default(0)
  isActive       Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user     User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  slides   LessonSlide[]
  sessions LessonSession[]
}

model LessonSlide {
  id             String   @id @default(cuid())
  lessonId       String
  index          Int
  text           String?
  prompt         String?
  rubric         String? // JSON array of strings
  responseType   String? // "text" | "drawing" | "both"
  responseConfig String? // JSON config for widgets
  createdAt      DateTime @default(now())

  lesson        Lesson                    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  responses     LessonResponse[]
  studentStates LessonStudentSlideState[]

  @@unique([lessonId, index])
}

model LessonSession {
  id                String    @id @default(cuid())
  lessonId          String
  mode              String    @default("instructor") // instructor | student
  currentSlideIndex Int       @default(1)
  isActive          Boolean   @default(true)
  isFrozen          Boolean   @default(false)
  paceConfig        String?
  timerEndsAt       DateTime?
  timerRemainingSec Int?
  timerRunning      Boolean   @default(false)
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  lesson             Lesson                    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  states             LessonSessionState[]
  responses          LessonResponse[]
  studentSlideStates LessonStudentSlideState[]
}

model LessonSessionState {
  id                String   @id @default(cuid())
  sessionId         String
  userId            String
  currentSlideIndex Int      @default(1)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  session LessonSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, userId])
}

model LessonResponse {
  id           String   @id @default(cuid())
  sessionId    String
  slideId      String
  userId       String
  response     String
  responseType String? // "text" | "drawing" | "both"
  drawingPath  String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  session LessonSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  slide   LessonSlide   @relation(fields: [slideId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, slideId, userId])
}

model LessonStudentSlideState {
  id              String   @id @default(cuid())
  sessionId       String
  slideId         String
  userId          String
  responseText    String   @default("")
  drawingPath     String?
  drawingText     String?
  drawingSnapshot String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  session LessonSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  slide   LessonSlide   @relation(fields: [slideId], references: [id], onDelete: Cascade)
  user    User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sessionId, slideId, userId])
}
